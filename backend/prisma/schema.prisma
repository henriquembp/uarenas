// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  VISITOR
}

enum OrganizationPlan {
  FREE
  BASIC
  PREMIUM
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum StockMovementType {
  ENTRY
  EXIT
  ADJUSTMENT
}

model Organization {
  id            String           @id @default(uuid())
  name          String
  subdomain     String           @unique // Para URLs: arena-a.uarenas.com
  domain        String?          @unique // Domínio customizado: arena-a.com.br
  plan          OrganizationPlan @default(FREE)
  isActive      Boolean          @default(true)
  // Personalização
  logoUrl       String?          // URL da logo/marca
  primaryColor  String?          // Cor primária (ex: #3B82F6)
  secondaryColor String?          // Cor secundária (ex: #8B5CF6)
  accentColor   String?          // Cor de destaque (ex: #F59E0B)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relações
  users     User[]
  courts    Court[]
  bookings  Booking[]
  classes   Class[]
  stores    Store[]
  invoices  Invoice[]
  sales      Sale[]

  @@map("organizations")
}

model User {
  id             String    @id @default(uuid())
  organizationId String
  email          String
  password       String
  name           String
  phone          String?
  role           UserRole  @default(VISITOR)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relações
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookings       Booking[]
  classesAsStudent ClassStudent[]
  classesAsTeacher Class[] @relation("ClassTeacher")
  invoices       Invoice[]
  stockMovements StockMovement[]
  sales          Sale[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@map("users")
}

model Court {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  sportType      String   // "esportes_areia" - Esportes de Areia (Beach Tennis, Vôlei, Futevôlei)
  isActive       Boolean  @default(true)
  imageUrl       String?
  defaultPrice   Decimal? @db.Decimal(10, 2) // Valor padrão do horário de locação
  premiumPrice   Decimal? @db.Decimal(10, 2) // Valor do horário nobre
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relações
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookings       Booking[]
  classes        Class[]
  availability   CourtAvailability[]

  @@index([organizationId])
  @@map("courts")
}

model CourtAvailability {
  id        String    @id @default(uuid())
  courtId   String
  dayOfWeek Int?      // 0 = Domingo, 1 = Segunda, ..., 6 = Sábado (null = data específica)
  specificDate DateTime? // Data específica (para feriados, manutenção, etc.)
  timeSlot  String    // Formato HH:mm (ex: "14:00", "14:30")
  isPremium Boolean   @default(false) // Marca se é horário nobre
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relações
  court     Court     @relation(fields: [courtId], references: [id], onDelete: Cascade)

  @@unique([courtId, dayOfWeek, timeSlot])
  @@unique([courtId, specificDate, timeSlot])
  @@map("court_availability")
}

model Booking {
  id             String        @id @default(uuid())
  organizationId String
  userId         String
  courtId        String
  date           DateTime
  startTime      String        // Formato HH:mm
  endTime        String        // Formato HH:mm
  status         BookingStatus @default(PENDING)
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relações
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  court          Court         @relation(fields: [courtId], references: [id], onDelete: Cascade)
  invoices       Invoice[]

  @@index([organizationId])
  @@map("bookings")
}

model Class {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  courtId        String
  teacherId      String
  dayOfWeek      Int      // 0 = Domingo, 1 = Segunda, ..., 6 = Sábado
  startTime      String   // Formato HH:mm
  endTime        String   // Formato HH:mm
  startDate      DateTime
  endDate        DateTime?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relações
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  court          Court        @relation(fields: [courtId], references: [id], onDelete: Cascade)
  teacher        User         @relation("ClassTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  students       ClassStudent[]
  invoices       Invoice[]

  @@index([organizationId])
  @@map("classes")
}

model ClassStudent {
  id        String   @id @default(uuid())
  classId   String
  studentId String
  joinedAt  DateTime @default(now())
  leftAt    DateTime?

  // Relações
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@map("class_students")
}

model Invoice {
  id             String        @id @default(uuid())
  organizationId String
  userId         String
  bookingId      String?       // Relacionamento com reserva
  classId        String?
  description    String
  amount         Decimal       @db.Decimal(10, 2)
  dueDate        DateTime
  paidDate       DateTime?
  status         InvoiceStatus @default(PENDING)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relações
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking        Booking?      @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  class          Class?        @relation(fields: [classId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([bookingId])
  @@map("invoices")
}

model Store {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relações
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  products       Product[]

  @@index([organizationId])
  @@map("stores")
}

model Product {
  id          String   @id @default(uuid())
  storeId     String
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  cost        Decimal? @db.Decimal(10, 2)
  sku         String?  @unique
  barcode     String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  stockMovements StockMovement[]
  saleItems   SaleItem[]

  @@map("products")
}

model StockMovement {
  id          String            @id @default(uuid())
  productId   String
  userId      String?           // Usuário que fez o movimento
  type        StockMovementType
  quantity    Int
  notes       String?
  createdAt   DateTime          @default(now())

  // Relações
  product     Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  user        User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("stock_movements")
}

model Sale {
  id             String   @id @default(uuid())
  organizationId String
  userId         String   // Vendedor
  total          Decimal  @db.Decimal(10, 2)
  notes          String?
  createdAt      DateTime @default(now())

  // Relações
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  items          SaleItem[]

  @@index([organizationId])
  @@map("sales")
}

model SaleItem {
  id          String   @id @default(uuid())
  saleId      String
  productId   String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  subtotal    Decimal  @db.Decimal(10, 2)

  // Relações
  sale        Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("sale_items")
}



